<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>MNIST App</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>

<!-- Markup adapted from use of Bootsrap site https://getbootstrap.com/docs/4.0/layout/overview/ -->

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light p-3">
        <div>
            <a href="#" class="navbar-brand">
                MNIST Classifier
            </a>
        </div>
    </nav>

    <div class="row">
        <div class="col-xs-12">

            <div class="card mx-auto mt-3 p-3" style="height: 570px;">
                <div class="card-body text-center">
                    <h1 class="card-title">Draw a Number between 0 - 9 in the canvas
                    </h1>
                    <hr>

                    <div>
                        <canvas id="mnist" width="100px" height="500px" style="border: 5px solid black;"></canvas>
                    </div>

                    <hr>

                    <div>
                        <button class="btn btn-primary" type="button" onclick="saveCanvasAsImg()">
                            Save Canvas
                        </button>
                        <button style="margin-left: 5px;" class="btn btn-danger" type="button" onclick="clearCanvas()">
                            Clear Canvas
                        </button>
                    </div>
                </div>
            </div>

        </div>


        <div class="col-xs-12 mx-auto">

            <div class="card mx-auto mt-3 p-3" style="height: 570px;">
                <div class="card-body text-center">
                    <h1 class="card-title">
                        Your Image
                    </h1>
                    <hr>

                    <div>
                        <img height="300" width="400" id="userImage" alt="Waiting for image to be saved!">


                    </div>

                    <div class="text-center">
                        <h2 id="target-text" class="card-title"></h2>
                    </div>

                    <hr>

                    <div class="text-center">
                        <button class="btn btn-primary" type="button" onclick="classifyImage()">
                            Classify
                        </button>
                    </div>

                </div>
            </div>

        </div>
    </div>



    <script type="text/javascript">

        /*
            Draw on canvas code adapted from youtube series 
            https://www.youtube.com/watch?v=m4sioSqlXhQ&list=PLfdtiltiRHWHfOVfqI89Nc3xUMY-q-7f0 

            Also got canvas info from
            https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API 
        */

        let canvas = document.getElementById('mnist');
        let ctx = canvas.getContext("2d");

        let radius = 10;
        let mouseDown = false;

        canvas.width = window.innerWidth / 2;
        canvas.height = window.innerHeight / 2;

        ctx.lineWidth = radius * 2;

        // Chose Blue for drawing as black no good on server side when converted to gray scale.
        // image data be represented as all 0's
        ctx.strokeStyle = "#0000FF";
        ctx.fillStyle = "#0000FF";

        // needed for positions on camvas to match mouse pointer to drawing position
        // https://developer.mozilla.org/en-US/docs/Web/API/Element/getBoundingClientRect
        let rect = canvas.getBoundingClientRect();

        let putPoint = (e) => {
            if (mouseDown) {
                // fix to mouse pointer position
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);

                ctx.stroke();
                ctx.beginPath();
                ctx.arc(e.clientX - rect.left, e.clientY - rect.top, radius, 0, Math.PI * 2);
                ctx.fill();

                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }
        };

        let draw = (e) => {
            mouseDown = true;
            putPoint(e);
        };

        let stopDraw = () => {
            mouseDown = false;
            ctx.beginPath();
        };

        canvas.addEventListener('mousedown', draw);

        canvas.addEventListener('mouseup', stopDraw);

        canvas.addEventListener('mousemove', putPoint);

        // Reset canvas and image values

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();

            document.getElementById("target-text").innerHTML = null;
            document.getElementById('userImage').src = null;
        }

        // convert image data to base 64 string and set image source on web page 

        function saveCanvasAsImg() {
            let dataUrl = canvas.toDataURL();

            document.getElementById('userImage').src = dataUrl;
        }

        // post image data to flask server

        function classifyImage() {
            let imageUrl = canvas.toDataURL();

            // split image string so it's only the base 64 image data
            let imgData = imageUrl.split(',')[1];

            //send as object
            let postObj = {
                'dataUrl': imgData
            };

            // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API
            // Built in web HTTP Client
            // post image data to server on port 5000  
            fetch('http://localhost:5000/classify-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(postObj)
            })
                .then(response => {
                    // handling json data async response
                    // https://www.taniarascia.com/how-to-use-the-javascript-fetch-api-to-get-json-data/
                    return response.json();
                })
                .then(result => {
                    console.log('result: ', result["prediction"]);
                    document.getElementById("target-text").innerHTML = result["prediction"];
                })
                .catch(err => {
                    console.log(err);
                });
        }


    </script>
</body>

</html>