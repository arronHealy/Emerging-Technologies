<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
</head>


<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light p-3">
        <div>
            <a href="#" class="navbar-brand">
                MNIST Classifier
            </a>
        </div>
    </nav>

    <div class="row">
        <div class="col-xs-12">

            <div class="card mx-auto mt-3 p-3" style="height: 570px;">
                <div class="card-body text-center">
                    <h1 class="card-title">Draw a Number between 0 - 9 in the canvas
                    </h1>
                    <hr>

                    <div>
                        <canvas id="mnist" width="100px" height="500px" style="border: 5px solid black;"></canvas>
                    </div>

                    <hr>

                    <div>
                        <button class="btn btn-primary" type="button" onclick="saveCanvasAsImg()">
                            Save Canvas
                        </button>
                        <button style="margin-left: 5px;" class="btn btn-danger" type="button" onclick="clearCanvas()">
                            Clear Canvas
                        </button>
                    </div>
                </div>
            </div>

        </div>


        <div class="col-xs-12 mx-auto">

            <div class="card mx-auto mt-3 p-3" style="height: 570px;">
                <div class="card-body text-center">
                    <h1 class="card-title">
                        Your Image
                    </h1>
                    <hr>

                    <div>
                        <img height="300" width="400" id="userImage" alt="Waiting for image to be saved!">


                    </div>

                    <hr>

                    <div>
                        <button class="btn btn-primary" type="button" onclick="classifyImage()">
                            Classify
                        </button>
                        <button style="margin-left: 5px;" class="btn btn-danger" type="button">
                            Delete Image
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>



    <script type="text/javascript">
        var canvas = document.getElementById('mnist');
        var ctx = canvas.getContext("2d");

        var radius = 10;
        var mouseDown = false;

        canvas.width = window.innerWidth / 2;
        canvas.height = window.innerHeight / 2;

        ctx.lineWidth = radius * 2;
        ctx.strokeStyle = "#0000FF";
        ctx.fillStyle = "#0000FF";

        var rect = canvas.getBoundingClientRect();

        var putPoint = (e) => {
            if (mouseDown) {
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);

                ctx.stroke();
                ctx.beginPath();
                ctx.arc(e.clientX - rect.left, e.clientY - rect.top, radius, 0, Math.PI * 2);
                ctx.fill();

                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }
        };

        var draw = (e) => {
            mouseDown = true;
            putPoint(e);
        };

        var stopDraw = () => {
            mouseDown = false;
            ctx.beginPath();
        };

        canvas.addEventListener('mousedown', draw);

        canvas.addEventListener('mouseup', stopDraw);

        canvas.addEventListener('mousemove', putPoint);

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.beginPath();
        }

        function saveCanvasAsImg() {

            var dataUrl = canvas.toDataURL();

            document.getElementById('userImage').src = dataUrl;

        }

        /*
                function dataURIToBlob(dataURI) {
                    //var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
        
                    var arrBuffer = new ArrayBuffer(dataURI.length)
                    var intArr = new Uint8Array(arrBuffer);
        
                    for (var i = 0; i < dataURI.length; i++) {
                        intArr[i] = dataURI.charCodeAt(i);
                    }
        
                    var blob = new Blob([arrBuffer]);
        
                    return blob;
                }
        */
        function classifyImage() {
            var imageUrl = canvas.toDataURL();

            var imgData = imageUrl.split(',')[1];

            let postObj = {
                'dataUrl': imgData
            };

            fetch('http://localhost:5000/classify-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(postObj)
            })
                .then(response => {
                    console.log(response.json());
                })
                .catch(err => {
                    console.log(err);
                });
        }


    </script>
</body>

</html>